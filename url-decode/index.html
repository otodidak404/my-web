<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Link</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 4px;
            word-break: break-all;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .visitor-details {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
        .map {
            height: 300px;
            width: 100%;
            margin-top: 15px;
            border-radius: 5px;
        }
        .copy-btn {
            background-color: #2196F3;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>Trace Link</h1>
    
    <div class="tabs">
        <div class="tab active" onclick="showTab('create')">Buat Link</div>
        <div class="tab" onclick="showTab('view')">Lihat Data</div>
    </div>
    
    <div id="create" class="tab-content active container">
        <h2>Buat Link Pelacak</h2>
        <div class="form-group">
            <label for="destination">URL Tujuan (yang akan dikunjungi):</label>
            <input type="url" id="destination" placeholder="https://google.com" required>
        </div>
        <div class="form-group">
            <label for="alias">Alias (opsional):</label>
            <input type="text" id="alias" placeholder="misalnya: link-google">
        </div>
        <button onclick="createLink()">Buat Link</button>
        
        <div id="linkResult" class="result" style="display: none;">
            <p><strong>Link Pelacak:</strong> <span id="trackerLink"></span> 
            <button class="copy-btn" onclick="copyToClipboard('trackerLink')">Salin</button></p>
            <p>Bagikan link ini kepada target. Semua informasi akan disimpan saat mereka mengklik link.</p>
        </div>
    </div>
    
    <div id="view" class="tab-content container">
        <h2>Lihat Data Kunjungan</h2>
        <div class="form-group">
            <label for="viewAlias">Masukkan Alias atau ID Link:</label>
            <input type="text" id="viewAlias" placeholder="Masukkan alias atau ID link">
        </div>
        <button onclick="viewVisitorData()">Lihat Data</button>
        
        <div id="visitorData" style="display: none;">
            <h3>Data Kunjungan</h3>
            <table id="visitorTable">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>IP Address</th>
                        <th>Lokasi</th>
                        <th>Device</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="visitorTableBody">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
            
            <div id="visitorDetails" class="visitor-details" style="display: none;">
                <h3>Detail Kunjungan</h3>
                <div id="detailContent"></div>
                <div id="map" class="map"></div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi untuk menampilkan tab
        function showTab(tabName) {
            const tabs = document.getElementsByClassName('tab');
            const tabContents = document.getElementsByClassName('tab-content');
            
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab:nth-child(${tabName === 'create' ? 1 : 2})`).classList.add('active');
        }
        
        // Fungsi untuk membuat link pelacak
        function createLink() {
            const destination = document.getElementById('destination').value;
            let alias = document.getElementById('alias').value;
            
            if (!destination) {
                alert('Masukkan URL tujuan!');
                return;
            }
            
            // Jika alias tidak diisi, buat ID acak
            if (!alias) {
                alias = generateRandomID();
            }
            
            // Simpan data ke localStorage
            const linkData = {
                destination: destination,
                createdAt: new Date().toISOString(),
                visitors: []
            };
            
            localStorage.setItem(`trackLink_${alias}`, JSON.stringify(linkData));
            
            // Tampilkan hasil
            const currentURL = window.location.href.split('?')[0];
            const trackerLink = `${currentURL}?id=${alias}&redirect=${encodeURIComponent(destination)}`;
            
            document.getElementById('trackerLink').textContent = trackerLink;
            document.getElementById('linkResult').style.display = 'block';
        }
        
        // Fungsi untuk melihat data pengunjung
        function viewVisitorData() {
            const alias = document.getElementById('viewAlias').value;
            
            if (!alias) {
                alert('Masukkan alias atau ID link!');
                return;
            }
            
            const linkData = JSON.parse(localStorage.getItem(`trackLink_${alias}`));
            
            if (!linkData) {
                alert('Link tidak ditemukan!');
                return;
            }
            
            const visitors = linkData.visitors;
            const tableBody = document.getElementById('visitorTableBody');
            tableBody.innerHTML = '';
            
            if (visitors.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">Belum ada kunjungan</td></tr>';
            } else {
                visitors.forEach((visitor, index) => {
                    const row = document.createElement('tr');
                    
                    const timeCell = document.createElement('td');
                    timeCell.textContent = new Date(visitor.timestamp).toLocaleString();
                    
                    const ipCell = document.createElement('td');
                    ipCell.textContent = visitor.ip || 'Tidak diketahui';
                    
                    const locationCell = document.createElement('td');
                    locationCell.textContent = visitor.location ? `${visitor.location.city}, ${visitor.location.country}` : 'Tidak diketahui';
                    
                    const deviceCell = document.createElement('td');
                    deviceCell.textContent = visitor.browser || 'Tidak diketahui';
                    
                    const actionCell = document.createElement('td');
                    const detailBtn = document.createElement('button');
                    detailBtn.textContent = 'Detail';
                    detailBtn.onclick = () => showVisitorDetail(visitor);
                    actionCell.appendChild(detailBtn);
                    
                    row.appendChild(timeCell);
                    row.appendChild(ipCell);
                    row.appendChild(locationCell);
                    row.appendChild(deviceCell);
                    row.appendChild(actionCell);
                    
                    tableBody.appendChild(row);
                });
            }
            
            document.getElementById('visitorData').style.display = 'block';
            document.getElementById('visitorDetails').style.display = 'none';
        }
        
        // Fungsi untuk menampilkan detail pengunjung
        function showVisitorDetail(visitor) {
            const detailContent = document.getElementById('detailContent');
            detailContent.innerHTML = `
                <p><strong>Waktu Kunjungan:</strong> ${new Date(visitor.timestamp).toLocaleString()}</p>
                <p><strong>IP Address:</strong> ${visitor.ip || 'Tidak diketahui'}</p>
                <p><strong>User Agent:</strong> ${visitor.userAgent || 'Tidak diketahui'}</p>
                <p><strong>Browser:</strong> ${visitor.browser || 'Tidak diketahui'}</p>
                <p><strong>Sistem Operasi:</strong> ${visitor.os || 'Tidak diketahui'}</p>
                <p><strong>Resolusi Layar:</strong> ${visitor.screen || 'Tidak diketahui'}</p>
                <p><strong>Bahasa:</strong> ${visitor.language || 'Tidak diketahui'}</p>
                <p><strong>Lokasi:</strong> ${visitor.location ? `${visitor.location.city}, ${visitor.location.region}, ${visitor.location.country} (${visitor.location.postal || 'N/A'})` : 'Tidak diketahui'}</p>
                <p><strong>Koordinat:</strong> ${visitor.location ? `${visitor.location.latitude}, ${visitor.location.longitude}` : 'Tidak diketahui'}</p>
                <p><strong>ISP:</strong> ${visitor.location ? visitor.location.org || 'Tidak diketahui' : 'Tidak diketahui'}</p>
            `;
            
            // Tampilkan peta jika ada lokasi
            if (visitor.location && visitor.location.latitude && visitor.location.longitude) {
                const mapElem = document.getElementById('map');
                const lat = visitor.location.latitude;
                const lng = visitor.location.longitude;
                
                // Buat iframe untuk OpenStreetMap
                const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.01},${lat-0.01},${lng+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lng}`;
                const iframe = document.createElement('iframe');
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.frameBorder = '0';
                iframe.style.border = '0';
                iframe.src = mapUrl;
                
                mapElem.innerHTML = '';
                mapElem.appendChild(iframe);
                mapElem.style.display = 'block';
            } else {
                document.getElementById('map').style.display = 'none';
            }
            
            document.getElementById('visitorDetails').style.display = 'block';
        }
        
        // Fungsi untuk menghasilkan ID acak
        function generateRandomID() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Fungsi untuk menyalin teks ke clipboard
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(function() {
                alert('Link berhasil disalin!');
            }, function(err) {
                console.error('Gagal menyalin: ', err);
            });
        }
        
        // Cek apakah ini merupakan kunjungan dari target
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const redirect = urlParams.get('redirect');
            
            if (id && redirect) {
                // Ini adalah kunjungan dari target, kumpulkan informasi
                collectVisitorInfo(id, redirect);
            }
        };
        
        // Fungsi untuk mengumpulkan informasi pengunjung
        function collectVisitorInfo(id, redirect) {
            // Mendapatkan data link dari localStorage
            const linkData = JSON.parse(localStorage.getItem(`trackLink_${id}`));
            
            if (!linkData) {
                // Jika link tidak ditemukan, redirect langsung
                window.location.href = redirect;
                return;
            }
            
            // Kumpulkan informasi pengunjung
            const visitorInfo = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                language: navigator.language || navigator.userLanguage,
                screen: `${window.screen.width} x ${window.screen.height}`,
                browser: getBrowser(),
                os: getOS()
            };
            
            // Deteksi OS
            function getOS() {
                const userAgent = navigator.userAgent;
                let os = "Tidak terdeteksi";
                
                if (/Windows/.test(userAgent)) os = "Windows";
                else if (/Macintosh|Mac OS X/.test(userAgent)) os = "macOS";
                else if (/Linux/.test(userAgent)) os = "Linux";
                else if (/Android/.test(userAgent)) os = "Android";
                else if (/iPhone|iPad|iPod/.test(userAgent)) os = "iOS";
                
                return os;
            }
            
            // Deteksi Browser
            function getBrowser() {
                const userAgent = navigator.userAgent;
                let browser = "Tidak terdeteksi";
                
                if (/Chrome/.test(userAgent) && !/Chromium|Edge|Edg|OPR|Opera/.test(userAgent)) browser = "Google Chrome";
                else if (/Firefox/.test(userAgent)) browser = "Mozilla Firefox";
                else if (/Safari/.test(userAgent) && !/Chrome|Chromium|Edge|Edg|OPR|Opera/.test(userAgent)) browser = "Safari";
                else if (/Edge|Edg/.test(userAgent)) browser = "Microsoft Edge";
                else if (/OPR|Opera/.test(userAgent)) browser = "Opera";
                else if (/MSIE|Trident/.test(userAgent)) browser = "Internet Explorer";
                
                return browser;
            }
            
            // Mendapatkan IP dan lokasi (menggunakan API publik)
            fetch('https://ipapi.co/json/')
                .then(response => response.json())
                .then(data => {
                    visitorInfo.ip = data.ip;
                    visitorInfo.location = {
                        city: data.city,
                        region: data.region,
                        country: data.country_name,
                        postal: data.postal,
                        latitude: data.latitude,
                        longitude: data.longitude,
                        org: data.org
                    };
                    
                    // Coba dapatkan lokasi yang lebih akurat
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                visitorInfo.location.preciseLatitude = position.coords.latitude;
                                visitorInfo.location.preciseLongitude = position.coords.longitude;
                                finishCollection();
                            },
                            function(error) {
                                finishCollection();
                            }
                        );
                    } else {
                        finishCollection();
                    }
                })
                .catch(error => {
                    finishCollection();
                });
            
            function finishCollection() {
                // Simpan data pengunjung
                linkData.visitors.push(visitorInfo);
                localStorage.setItem(`trackLink_${id}`, JSON.stringify(linkData));
                
                // Redirect ke tujuan
                window.location.href = redirect;
            }
        }
    </script>
</body>
</html>
